<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with {{ document.original_filename }} - Local RAG</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-robot me-2"></i>Local RAG
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="fas fa-arrow-left me-1"></i>Back to Documents
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Document Info Sidebar -->
            <div class="col-md-3">
                <div class="card sticky-top">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-file-pdf text-danger me-2"></i>Document
                        </h6>
                    </div>
                    <div class="card-body">
                        <h6 class="text-truncate" title="{{ document.original_filename }}">
                            {{ document.original_filename }}
                        </h6>
                        <div class="small text-muted">
                            <div class="mb-2">
                                <i class="fas fa-file-alt me-1"></i>{{ document.page_count }} pages
                            </div>
                            <div class="mb-2">
                                <i class="fas fa-th-large me-1"></i>{{ document.chunk_count }} chunks
                            </div>
                            <div class="mb-2">
                                <i class="fas fa-calendar me-1"></i>{{ document.upload_date.strftime('%Y-%m-%d') }}
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-secondary w-100 mb-2" onclick="clearChat()">
                                <i class="fas fa-trash me-1"></i>Clear Chat
                            </button>
                            <button class="btn btn-sm btn-outline-info w-100" onclick="showSampleQuestions()">
                                <i class="fas fa-question me-1"></i>Sample Questions
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="col-md-9">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-comments me-2"></i>Chat with Document
                        </h5>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <!-- Chat Messages -->
                        <div id="chatMessages" class="flex-grow-1 overflow-auto mb-3" style="height: 60vh;">
                            {% if messages %}
                                {% for message in messages %}
                                    <div class="message mb-3 {{ 'user-message' if message.is_user else 'assistant-message' }}">
                                        <div class="d-flex {{ 'justify-content-end' if message.is_user else 'justify-content-start' }}">
                                            <div class="message-content {{ 'bg-primary text-white' if message.is_user else 'bg-secondary' }} rounded p-3" style="max-width: 80%;">
                                                <div class="message-text">{{ message.message }}</div>
                                                <div class="message-time text-muted small mt-2">
                                                    {{ message.timestamp.strftime('%H:%M') }}
                                                </div>
                                                {% if not message.is_user and message.sources %}
                                                    <div class="sources mt-2">
                                                        <button class="btn btn-sm btn-outline-light" onclick="toggleSources(this)">
                                                            <i class="fas fa-book me-1"></i>Sources
                                                        </button>
                                                        <div class="sources-content" style="display: none;">
                                                            {% set sources = message.sources | fromjson %}
                                                            {% for source in sources %}
                                                                <div class="source-item mt-2 p-2 border rounded">
                                                                    <div class="small">
                                                                        <strong>Page {{ source.page_number }}</strong>
                                                                        <span class="text-muted">({{ "%.2f"|format(source.similarity) }} similarity)</span>
                                                                    </div>
                                                                    <div class="small mt-1">{{ source.text }}</div>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-comment-dots fa-3x mb-3"></i>
                                    <h5>Start a conversation</h5>
                                    <p>Ask questions about the document content</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Chat Input -->
                        <div class="chat-input">
                            <form id="chatForm">
                                <div class="input-group">
                                    <input type="text" id="messageInput" class="form-control" placeholder="Ask a question about the document..." required>
                                    <button type="submit" class="btn btn-primary" id="sendButton">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sample Questions Modal -->
    <div class="modal fade" id="sampleQuestionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sample Questions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Try asking these types of questions:</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary text-start" onclick="useQuestion(this)">
                            What is the main topic of this document?
                        </button>
                        <button class="btn btn-outline-primary text-start" onclick="useQuestion(this)">
                            Can you summarize the key points?
                        </button>
                        <button class="btn btn-outline-primary text-start" onclick="useQuestion(this)">
                            What are the most important findings?
                        </button>
                        <button class="btn btn-outline-primary text-start" onclick="useQuestion(this)">
                            Are there any specific recommendations?
                        </button>
                        <button class="btn btn-outline-primary text-start" onclick="useQuestion(this)">
                            What methodology was used?
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Chat functionality
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatForm = document.getElementById('chatForm');
        
        const documentId = '{{ document.id }}';
        const sessionId = '{{ chat_session.id }}';
        
        // Auto-scroll to bottom
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Add message to chat
        function addMessage(message, isUser = false, sources = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message mb-3 ${isUser ? 'user-message' : 'assistant-message'}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
            
            let sourcesHtml = '';
            if (sources && sources.length > 0) {
                sourcesHtml = `
                    <div class="sources mt-2">
                        <button class="btn btn-sm btn-outline-light" onclick="toggleSources(this)">
                            <i class="fas fa-book me-1"></i>Sources
                        </button>
                        <div class="sources-content" style="display: none;">
                            ${sources.map(source => `
                                <div class="source-item mt-2 p-2 border rounded">
                                    <div class="small">
                                        <strong>Page ${source.page_number}</strong>
                                        <span class="text-muted">(${source.similarity.toFixed(2)} similarity)</span>
                                    </div>
                                    <div class="small mt-1">${source.text}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'}">
                    <div class="message-content ${isUser ? 'bg-primary text-white' : 'bg-secondary'} rounded p-3" style="max-width: 80%;">
                        <div class="message-text">${message}</div>
                        <div class="message-time text-muted small mt-2">${timeString}</div>
                        ${sourcesHtml}
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // Toggle sources visibility
        function toggleSources(button) {
            const sourcesContent = button.nextElementSibling;
            if (sourcesContent.style.display === 'none') {
                sourcesContent.style.display = 'block';
                button.innerHTML = '<i class="fas fa-book me-1"></i>Hide Sources';
            } else {
                sourcesContent.style.display = 'none';
                button.innerHTML = '<i class="fas fa-book me-1"></i>Sources';
            }
        }
        
        // Handle form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const question = messageInput.value.trim();
            if (!question) return;
            
            // Add user message
            addMessage(question, true);
            
            // Clear input and disable send button
            messageInput.value = '';
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: question,
                        document_id: documentId,
                        session_id: sessionId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addMessage(data.response, false, data.sources);
                } else {
                    addMessage(`Error: ${data.error}`, false);
                }
            } catch (error) {
                addMessage(`Error: ${error.message}`, false);
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                messageInput.focus();
            }
        });
        
        // Clear chat
        function clearChat() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                location.reload();
            }
        }
        
        // Show sample questions
        function showSampleQuestions() {
            new bootstrap.Modal(document.getElementById('sampleQuestionsModal')).show();
        }
        
        // Use sample question
        function useQuestion(button) {
            messageInput.value = button.textContent.trim();
            bootstrap.Modal.getInstance(document.getElementById('sampleQuestionsModal')).hide();
            messageInput.focus();
        }
        
        // Auto-scroll on load
        scrollToBottom();
        
        // Focus input
        messageInput.focus();
    </script>
</body>
</html>
